<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bugler ‚Äî Adaptive Learning</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
  
  <script>
    window.onerror = function(msg, url, line) {
        document.body.innerHTML = `<div style="color:white;text-align:center;padding:50px;background:#1a1a2e;height:100vh;">
            <h1 style="color:#ff4444">‚ö†Ô∏è Something went wrong</h1>
            <p>${msg}</p><p>Line: ${line}</p>
            <button onclick="localStorage.clear();location.reload()" style="padding:15px;cursor:pointer;font-weight:bold;">Reset App</button>
        </div>`;
    };
  </script>

  <style>
    /* --- DEFAULT DARK THEME --- */
    :root {
      --bg: #1a1a2e; 
      --card: #16213e; 
      --text: #e94560; 
      --primary: #0f3460;
      --green: #27AE60; 
      --amber: #F39C12; 
      --red: #E74C3C; 
      --radius: 16px;
      --input-bg: rgba(255,255,255,0.05);
      --border: rgba(255,255,255,0.05);
    }

    /* --- LIGHT THEME OVERRIDES --- */
    body.light-mode {
      --bg: #f0f2f5;
      --card: #ffffff;
      --text: #2c3e50;
      --primary: #3498db;
      --green: #2ecc71;
      --amber: #f1c40f;
      --red: #e74c3c;
      --input-bg: #ecf0f1;
      --border: #ddd;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
        font-family: 'Arial', sans-serif; background: var(--bg); color: var(--text); 
        min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; 
        transition: background 0.3s, color 0.3s;
    }
    .container { width: 100%; max-width: 950px; position: relative; }
    
    /* SECTIONS */
    .section { display: none; animation: slideUp 0.4s ease-out; }
    .section.active { display: block; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

    /* UI ELEMENTS */
    .card { 
        background: var(--card); border-radius: var(--radius); padding: 40px; 
        box-shadow: 0 15px 40px rgba(0,0,0,0.15); text-align: center; 
        border: 1px solid var(--border); transition: background 0.3s;
    }
    .stack { display: flex; flex-direction: column; gap: 20px; }
    
    h1 { font-family: 'Luckiest Guy', cursive; font-size: 4rem; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); margin-bottom: 5px; }
    h2 { font-size: 2rem; margin-bottom: 15px; }
    .subtitle { font-size: 1.3rem; opacity: 0.8; margin-bottom: 20px; }
    .muted { opacity: 0.7; font-size: 0.9rem; }

    .btn { background: var(--primary); color: white; border: none; padding: 15px 35px; border-radius: var(--radius); font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: 0.2s; display: inline-block; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .btn:hover { transform: translateY(-3px); filter: brightness(1.1); }
    
    .back-btn { background: #95A5A6; color: white; border: none; padding: 10px 20px; border-radius: var(--radius); cursor: pointer; font-weight: bold; transition: 0.2s; }
    .back-btn:hover { background: #7F8C8D; }
    
    /* GRIDS */
    .pace-grid, .lang-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
    .pace-btn, .lang-btn { background: var(--card); border: 3px solid var(--primary); color: var(--primary); padding: 25px 15px; border-radius: var(--radius); font-weight: bold; cursor: pointer; transition: 0.2s; }
    .pace-btn:hover, .lang-btn:hover { background: var(--primary); color: white; transform: scale(1.05); }
    
    .level-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin: 20px 0; }
    .level-btn { background: var(--green); color: white; border: none; padding: 20px; border-radius: var(--radius); font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1.1rem; }
    .level-btn:hover { transform: scale(1.1); }

    /* GAME AREAS */
    .quiz-option { background: var(--card); border: 2px solid var(--primary); color: var(--primary); padding: 18px; border-radius: var(--radius); font-weight: bold; cursor: pointer; margin: 10px 0; width: 100%; font-size: 1.1rem; transition: 0.2s; }
    .quiz-option:hover { background: var(--primary); color: white; transform: translateX(5px); }

    .editor-container { text-align: left; margin: 20px 0; }
    .code-editor { width: 100%; height: 200px; background: #0d1117; color: #c9d1d9; font-family: 'Fira Code', monospace; padding: 15px; border-radius: 12px; border: 2px solid #30363d; outline: none; }
    .console-output { background: black; color: #00ff00; font-family: monospace; padding: 15px; border-radius: 8px; margin-top: 15px; min-height: 60px; white-space: pre-wrap; text-align: left; display: none; }
    .console-output.error { color: #ff5555; }
    
    .form-row input { width: 100%; padding: 15px; border-radius: 10px; border: 1px solid #777; background: var(--input-bg); color: var(--text); margin-bottom: 15px; font-size: 1rem; }

    /* PROFILE & CHAT */
    .profile-btn { position: fixed; top: 25px; right: 25px; width: 55px; height: 55px; background: var(--card); border: 2px solid var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; z-index: 2000; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .profile-dropdown { position: fixed; top: 90px; right: 25px; width: 260px; background: var(--card); border: 2px solid var(--primary); border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.2); display: none; z-index: 1999; }
    .profile-dropdown.open { display: block; }

    /* THEME TOGGLE BUTTON */
    .theme-btn { position: fixed; top: 25px; left: 25px; width: 55px; height: 55px; background: var(--card); border: 2px solid var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; z-index: 2000; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .theme-btn:hover { transform: scale(1.1); }

    .chat-btn { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; background: #8e44ad; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 35px; cursor: pointer; transition: 0.3s; z-index: 2000; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
    .chat-window { position: fixed; bottom: 110px; right: 30px; width: 340px; height: 450px; background: var(--card); border: 2px solid #8e44ad; border-radius: 15px; display: none; flex-direction: column; box-shadow: 0 15px 40px rgba(0,0,0,0.5); z-index: 2000; }
    .chat-window.open { display: flex; }
    .chat-header { background: #8e44ad; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; color: white; }
    .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: rgba(0,0,0,0.1); }
    .chat-input-area { padding: 10px; background: var(--card); display: flex; gap: 5px; }
    .chat-input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #555; background: var(--input-bg); color: var(--text); }
    .msg { padding: 10px 15px; border-radius: 10px; max-width: 85%; font-size: 0.95rem; }
    .msg.bot { background: rgba(128,128,128,0.2); align-self: flex-start; }
    .msg.user { background: #8e44ad; align-self: flex-end; color: white; }
    .msg a { color: #f1c40f; font-weight: bold; }
    .hint-box { background: rgba(243, 156, 18, 0.15); border-left: 5px solid var(--amber); padding: 15px; margin: 15px 0; text-align: left; color: var(--text); border-radius: 4px; display: none; }
    
    .success { color: var(--green); font-weight: bold; margin-top: 10px; }
    .error { color: var(--red); font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>

  <div class="theme-btn" onclick="toggleTheme()">üåô</div>

  <div class="container">
    <div id="startScreen" class="section active">
      <div class="card stack">
        <div style="font-size: 4rem;">üêû</div>
        <h1>Bugler</h1>
        <p class="subtitle">Master Coding the Fun Way!</p>
        <button class="btn" onclick="showSection('loginScreen')">Start Learning üöÄ</button>
      </div>
    </div>

    <div id="loginScreen" class="section">
      <div class="card stack">
        <h2>Save Your Progress</h2>
        <div class="auth-wrap" style="display:flex; gap:30px; justify-content:center; flex-wrap:wrap;">
          <div style="flex:1; min-width:280px; background:rgba(0,0,0,0.05); padding:30px; border-radius:16px;">
            <h3>Login</h3>
            <div class="form-row"><input id="loginUser" type="text" placeholder="Username"></div>
            <div class="form-row"><input id="loginPass" type="password" placeholder="Password"></div>
            <button class="btn" onclick="handleLogin()" style="width:100%">Sign In</button>
            <div id="loginMsg"></div>
          </div>
          <div style="flex:1; min-width:280px; background:rgba(0,0,0,0.05); padding:30px; border-radius:16px;">
            <h3>Register</h3>
            <div class="form-row"><input id="regUser" type="text" placeholder="Pick a Username"></div>
            <div class="form-row"><input id="regPass" type="password" placeholder="Create Password"></div>
            <button class="btn" onclick="handleRegister()" style="background:var(--green); width:100%">Create Account</button>
            <div id="regMsg"></div>
          </div>
        </div>
        <button class="back-btn" onclick="showSection('startScreen')">Back</button>
      </div>
    </div>

    <div id="paceSelect" class="section">
      <div class="card stack">
        <h2>Choose Mode</h2>
        <div class="pace-grid">
          <button class="pace-btn" onclick="setPace('kid')"><div style="font-size:2.5rem">üéà</div><div>Kid</div></button>
          <button class="pace-btn" onclick="setPace('beginner')"><div style="font-size:2.5rem">üìò</div><div>Beginner</div></button>
          <button class="pace-btn" onclick="setPace('pro')"><div style="font-size:2.5rem">üî•</div><div>Pro</div></button>
          <button class="pace-btn" onclick="setPace('expert')"><div style="font-size:2.5rem">üèÜ</div><div>Expert</div></button>
        </div>
        <button class="back-btn" onclick="showSection('loginScreen')">Back</button>
      </div>
    </div>

    <div id="langSelect" class="section">
      <div class="card stack">
        <h2 id="langTitle">Pick Language</h2>
        <div class="lang-grid">
          <button class="lang-btn" onclick="setLanguage('python')">üêç Python</button>
          <button class="lang-btn" onclick="setLanguage('javascript')">‚ö° JavaScript</button>
          <button class="lang-btn" onclick="setLanguage('html')"><div>üåê HTML</div></button>
          <button class="lang-btn" onclick="setLanguage('c')">‚öô C Lang</button>
        </div>
        <button class="back-btn" onclick="showSection('paceSelect')">Back</button>
      </div>
    </div>

    <div id="levelMenu" class="section">
      <div class="card stack">
        <h2 id="menuTitle">Levels</h2>
        <div id="dynamicLevelGrid" class="level-grid"></div>
        <button class="back-btn" onclick="showSection('langSelect')">Back</button>
      </div>
    </div>

    <div id="gameScreen" class="section">
      <div class="card stack">
        <h2 id="levelTitle">Level Title</h2>
        <p id="levelDesc" class="muted" style="text-align:left; line-height:1.6; font-size:1.1rem;"></p>
        
        <div id="quizArea" style="display:none;"></div>

        <div id="editorArea" style="display:none;">
            <div class="hint-box">
                <span class="hint-label">üí° Hint:</span> <span id="levelHintText"></span>
            </div>
            <div class="editor-container">
                <textarea id="codeEditor" class="code-editor" placeholder="Type your code here..."></textarea>
                <button class="run-btn" onclick="runCode()">‚ñ∂ Run Code</button>
                <div id="consoleOutput" class="console-output"></div>
                <div id="htmlPreview" style="background:white; color:black; padding:10px; margin-top:10px; border-radius:8px; display:none;"></div>
            </div>
        </div>
        <button class="back-btn" onclick="showSection('levelMenu')">Back to Levels</button>
      </div>
    </div>
  </div>

  <div id="profileBtn" class="profile-btn" onclick="toggleProfile()">üë§</div>
  <div id="profileDropdown" class="profile-dropdown">
      <div style="font-size:3rem; margin-bottom:10px;">üë§</div>
      <h3 id="profileName" style="color:var(--text); margin-bottom:5px;">User</h3>
      
      <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin:15px 0;">
          <p class="muted" style="font-size:0.8rem; margin-bottom:5px;">CODER RANK</p>
          <h4 id="userRank" style="color:var(--amber); margin:0;">Rookie üê£</h4>
          <p id="loginCount" class="muted" style="font-size:0.75rem; margin-top:5px;">Logins: 0</p>
      </div>

      <button class="btn" onclick="logout()" style="width:100%; background:var(--red); padding:10px; margin-top:5px;">Sign Out</button>
  </div>

  <div class="chat-btn" onclick="toggleChat()">ü§ñ</div>
  <div class="chat-window" id="chatWindow">
    <div class="chat-header"><span>Bugler Bot</span> <span onclick="toggleChat()" style="cursor:pointer">‚úï</span></div>
    <div class="chat-messages" id="chatMessages"><div class="msg bot">Hi! I can help with basic coding questions.</div></div>
    <div class="chat-input-area">
        <input type="text" id="chatInput" class="chat-input" placeholder="Ask a doubt..." onkeypress="if(event.key==='Enter') sendChat()">
        <button onclick="sendChat()" style="background:none;border:none;cursor:pointer;font-size:1.2rem;">‚û§</button>
    </div>
  </div>

  <script>
    // --- THEME LOGIC ---
    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        const isLight = document.body.classList.contains('light-mode');
        localStorage.setItem('bugler_theme', isLight ? 'light' : 'dark');
        document.querySelector('.theme-btn').innerText = isLight ? '‚òÄÔ∏è' : 'üåô';
    }

    // --- DATABASE ---
    const contentDB = {
        kid: {
            python: [
                { type:'quiz', title:"Hello", q:"How to print?", a:["print()", "say()", "log()"], correct:0 },
                { type:'quiz', title:"Math", q:"2 + 2?", a:["4", "22", "0"], correct:0 },
                { type:'quiz', title:"Loop", q:"Repeat code?", a:["for loop", "if", "var"], correct:0 },
                { type:'quiz', title:"Data", q:"Store text?", a:["String", "Int", "Bool"], correct:0 },
                { type:'quiz', title:"End", q:"Stop?", a:["break", "continue", "pass"], correct:0 }
            ],
            javascript: [
                { type:'quiz', title:"Msg", q:"Show alert?", a:["alert()", "msg()", "popup()"], correct:0 },
                { type:'quiz', title:"Var", q:"Make box?", a:["let", "make", "do"], correct:0 },
                { type:'quiz', title:"Log", q:"Console?", a:["console.log", "print", "out"], correct:0 },
                { type:'quiz', title:"Add", q:"10+5?", a:["15", "105", "50"], correct:0 },
                { type:'quiz', title:"Click", q:"Event?", a:["onclick", "press", "hit"], correct:0 }
            ],
            html: [ { type:'quiz', title:"Big", q:"Big text?", a:["h1", "p", "br"], correct:0 }, { type:'quiz', title:"Img", q:"Picture?", a:["img", "pic", "src"], correct:0 }, { type:'quiz', title:"Link", q:"Go url?", a:["a", "link", "go"], correct:0 }, { type:'quiz', title:"List", q:"Dots?", a:["ul", "ol", "li"], correct:0 }, { type:'quiz', title:"Btn", q:"Click?", a:["button", "box", "click"], correct:0 } ],
            c: [ { type:'quiz', title:"Print", q:"Output?", a:["printf", "cout", "echo"], correct:0 }, { type:'quiz', title:"Num", q:"Integer?", a:["int", "float", "str"], correct:0 }, { type:'quiz', title:"Main", q:"Start?", a:["main", "begin", "init"], correct:0 }, { type:'quiz', title:"Scan", q:"Input?", a:["scanf", "get", "in"], correct:0 }, { type:'quiz', title:"End", q:"Stop?", a:["return 0", "end", "stop"], correct:0 } ]
        },
        beginner: {
            python: [
                { type:'quiz', title:"Variables", q:"x = 10. Type of x?", a:["Integer", "String", "List"], correct:0 },
                { type:'quiz', title:"Input", q:"Get user name?", a:["input()", "get()", "scan()"], correct:0 },
                { type:'quiz', title:"Conditions", q:"if x > 5:", a:["Checks value", "Loops", "Prints"], correct:0 },
                { type:'quiz', title:"Loops", q:"Repeat code?", a:["for/while", "if/else", "def"], correct:0 },
                { type:'quiz', title:"Lists", q:"Container for items?", a:["[1, 2]", "(1, 2)", "{1, 2}"], correct:0 },
                { type:'quiz', title:"Functions", q:"Define a function?", a:["def name():", "function name()", "func name"], correct:0 },
                { type:'quiz', title:"Booleans", q:"True or False?", a:["bool", "int", "str"], correct:0 },
                { type:'quiz', title:"Modules", q:"Use math functions?", a:["import math", "using math", "include math"], correct:0 }
            ],
            javascript: [
                { type:'quiz', title:"Variables", q:"Variable that can't change?", a:["const", "let", "var"], correct:0 },
                { type:'quiz', title:"Functions", q:"Create function?", a:["function x()", "def x()", "func x()"], correct:0 },
                { type:'quiz', title:"Data Types", q:"'Hello' is a?", a:["String", "Int", "Boolean"], correct:0 },
                { type:'quiz', title:"Arrays", q:"List of items?", a:["[1, 2]", "(1, 2)", "{1, 2}"], correct:0 },
                { type:'quiz', title:"Objects", q:"Key-value pair?", a:["{a: 1}", "[a: 1]", "(a: 1)"], correct:0 },
                { type:'quiz', title:"Comparison", q:"Equal value & type?", a:["===", "==", "="], correct:0 },
                { type:'quiz', title:"Loops", q:"Standard loop?", a:["for(;;)", "loop()", "repeat"], correct:0 },
                { type:'quiz', title:"DOM", q:"Get element by ID?", a:["getElementById", "selectId", "queryId"], correct:0 }
            ],
            html: [
                { type:'quiz', title:"Structure", q:"Main container?", a:["<html>", "<body>", "<head>"], correct:0 },
                { type:'quiz', title:"Headings", q:"Smallest heading?", a:["<h6>", "<h1>", "<h0>"], correct:0 },
                { type:'quiz', title:"Lists", q:"Bulleted list?", a:["<ul>", "<ol>", "<list>"], correct:0 },
                { type:'quiz', title:"Links", q:"Link attribute?", a:["href", "src", "link"], correct:0 },
                { type:'quiz', title:"Images", q:"Image source?", a:["src", "href", "link"], correct:0 },
                { type:'quiz', title:"Line Break", q:"New line?", a:["<br>", "<lb>", "<break>"], correct:0 },
                { type:'quiz', title:"Input", q:"Type text?", a:["<input type='text'>", "<textbox>", "<write>"], correct:0 },
                { type:'quiz', title:"CSS Link", q:"Connect CSS?", a:["<link rel='stylesheet'>", "<style src>", "<css>"], correct:0 }
            ],
            c: [
                { type:'quiz', title:"Main", q:"Program entry?", a:["int main()", "start()", "program()"], correct:0 },
                { type:'quiz', title:"Print", q:"Output text?", a:["printf()", "print()", "cout"], correct:0 },
                { type:'quiz', title:"Integers", q:"Whole number type?", a:["int", "float", "double"], correct:0 },
                { type:'quiz', title:"Format", q:"Symbol for int?", a:["%d", "%f", "%s"], correct:0 },
                { type:'quiz', title:"Scan", q:"Get input?", a:["scanf()", "get()", "input()"], correct:0 },
                { type:'quiz', title:"If/Else", q:"Decision making?", a:["if(x==1)", "check(x=1)", "when(x1)"], correct:0 },
                { type:'quiz', title:"Comments", q:"Single line comment?", a:["//", "/*", "#"], correct:0 },
                { type:'quiz', title:"End Line", q:"Statement terminator?", a:[";", ".", ":"], correct:0 }
            ]
        },
        pro: {
            python: [
                { type:'code', title:"Sum List", desc:"Sum of [1,2,3]", solution:"sum", check:"6", hint:"sum()" },
                { type:'code', title:"Max Val", desc:"Max of [10,50]", solution:"max", check:"50", hint:"max()" },
                { type:'code', title:"Reverse", desc:"Reverse string", solution:"::-1", check:"", hint:"[::-1]" },
                { type:'code', title:"Count", desc:"Count 'a' in 'banana'", solution:".count", check:"3", hint:".count()" },
                { type:'code', title:"Range", desc:"Loop 0-4", solution:"range", check:"4", hint:"range(5)" },
                { type:'code', title:"Dict", desc:"Get value", solution:"['key']", check:"", hint:"d['key']" },
                { type:'code', title:"Sort", desc:"Sort list", solution:"sort", check:"", hint:".sort()" },
                { type:'code', title:"Set", desc:"Unique items", solution:"set", check:"", hint:"set()" },
                { type:'code', title:"Format", desc:"f-string", solution:"f'", check:"", hint:"f'{var}'" },
                { type:'code', title:"Append", desc:"Add to list", solution:"append", check:"", hint:".append()" }
            ],
            javascript: [
                { type:'code', title:"Map", desc:"Double numbers", solution:".map", check:"map", hint:".map(x=>x*2)" },
                { type:'code', title:"Filter", desc:"Filter > 10", solution:".filter", check:"filter", hint:".filter(x=>x>10)" },
                { type:'code', title:"Arrow", desc:"Arrow function", solution:"=>", check:"=>", hint:"() => {}" },
                { type:'code', title:"Find", desc:"Find first match", solution:".find", check:"find", hint:".find()" },
                { type:'code', title:"Reduce", desc:"Sum array", solution:".reduce", check:"reduce", hint:".reduce()" },
                { type:'code', title:"Template", desc:"Backticks string", solution:"`", check:"${", hint:"`Hi ${name}`" },
                { type:'code', title:"Destructure", desc:"Extract prop", solution:"{", check:"}", hint:"const {a} = obj" },
                { type:'code', title:"Spread", desc:"Copy array", solution:"...", check:"...", hint:"[...arr]" },
                { type:'code', title:"Async", desc:"Async func", solution:"async", check:"await", hint:"async/await" },
                { type:'code', title:"Class", desc:"Make class", solution:"class", check:"constructor", hint:"class X {}" }
            ],
            html: [
                { type:'code', title:"Flex", desc:"Flexbox layout", solution:"display: flex", check:"flex", hint:"display: flex" },
                { type:'code', title:"Grid", desc:"Grid layout", solution:"display: grid", check:"grid", hint:"display: grid" },
                { type:'code', title:"Input", desc:"Text input", solution:"<input", check:"text", hint:"<input type='text'>" },
                { type:'code', title:"Button", desc:"Clickable btn", solution:"<button>", check:"</button>", hint:"<button>" },
                { type:'code', title:"Link", desc:"Anchor tag", solution:"<a href", check:"</a>", hint:"<a href='...'>" },
                { type:'code', title:"Image", desc:"Show image", solution:"<img src", check:"src", hint:"<img src='...'>" },
                { type:'code', title:"List", desc:"Bullet list", solution:"<ul>", check:"<li>", hint:"<ul><li>" },
                { type:'code', title:"Class", desc:"CSS Class", solution:".", check:"{", hint:".classname {}" },
                { type:'code', title:"ID", desc:"CSS ID", solution:"#", check:"{", hint:"#idname {}" },
                { type:'code', title:"Color", desc:"Text color", solution:"color:", check:";", hint:"color: red;" }
            ],
            c: [
                { type:'code', title:"Pointer", desc:"Int pointer", solution:"int *", check:"ptr", hint:"int *p;" },
                { type:'code', title:"Address", desc:"Get address", solution:"&", check:"&", hint:"&var" },
                { type:'code', title:"Struct", desc:"Define struct", solution:"struct", check:"};", hint:"struct X {};" },
                { type:'code', title:"Malloc", desc:"Alloc memory", solution:"malloc", check:"sizeof", hint:"malloc(size)" },
                { type:'code', title:"Free", desc:"Free memory", solution:"free", check:";", hint:"free(ptr)" },
                { type:'code', title:"File", desc:"Open file", solution:"fopen", check:"FILE", hint:"fopen()" },
                { type:'code', title:"Switch", desc:"Switch case", solution:"switch", check:"case", hint:"switch(x)" },
                { type:'code', title:"While", desc:"While loop", solution:"while", check:"{", hint:"while(1)" },
                { type:'code', title:"Do-While", desc:"Do loop", solution:"do", check:"while", hint:"do {} while()" },
                { type:'code', title:"Function", desc:"Void func", solution:"void", check:"()", hint:"void f() {}" }
            ]
        },
        expert: {
            python: [
                { type:'code', title:"API", desc:"Fetch data", solution:"requests.get", check:"url", hint:"requests.get()" },
                { type:'code', title:"Class", desc:"OOP Class", solution:"class", check:"__init__", hint:"class Dog:" },
                { type:'code', title:"Try", desc:"Handle Error", solution:"try:", check:"except", hint:"try/except" },
                { type:'code', title:"File", desc:"Read file", solution:"open", check:"read", hint:"with open()..." },
                { type:'code', title:"Lambda", desc:"Inline func", solution:"lambda", check:":", hint:"lambda x: x" }
            ],
            javascript: [
                { type:'code', title:"Fetch", desc:"Get API", solution:"fetch", check:"then", hint:"fetch().then()" },
                { type:'code', title:"Promise", desc:"New Promise", solution:"new Promise", check:"resolve", hint:"new Promise()" },
                { type:'code', title:"Storage", desc:"Local Store", solution:"localStorage", check:"setItem", hint:"localStorage" },
                { type:'code', title:"DOM", desc:"Event Listener", solution:"addEventListener", check:"click", hint:"addEventListener" },
                { type:'code', title:"Modules", desc:"Import/Export", solution:"import", check:"from", hint:"import X from Y" }
            ],
            html: [
                { type:'code', title:"Media", desc:"Responsive", solution:"@media", check:"screen", hint:"@media screen" },
                { type:'code', title:"Anim", desc:"Keyframes", solution:"@keyframes", check:"%", hint:"@keyframes" },
                { type:'code', title:"Var", desc:"CSS Var", solution:"--", check:"var(", hint:"var(--color)" },
                { type:'code', title:"Form", desc:"Validation", solution:"required", check:"pattern", hint:"pattern='...'" },
                { type:'code', title:"Canvas", desc:"Draw", solution:"<canvas>", check:"id", hint:"<canvas>" }
            ],
            c: [
                { type:'code', title:"Macro", desc:"Define const", solution:"#define", check:"MAX", hint:"#define" },
                { type:'code', title:"Bitwise", desc:"AND operator", solution:"&", check:"|", hint:"& | ^" },
                { type:'code', title:"Typedef", desc:"Alias type", solution:"typedef", check:"struct", hint:"typedef" },
                { type:'code', title:"Union", desc:"Union type", solution:"union", check:"};", hint:"union" },
                { type:'code', title:"Header", desc:"Include local", solution:"#include", check:".h", hint:"#include \"file.h\"" }
            ]
        }
    };

    // --- SETUP ---
    const API_URL = 'http://localhost:5000/api';
    let currentMode='beginner', currentLang='python', currentLevelIdx=0;
    let currentUser=null, authToken=null;

    window.onload = function() {
        // Load Theme
        const savedTheme = localStorage.getItem('bugler_theme');
        if(savedTheme === 'light') {
            document.body.classList.add('light-mode');
            document.querySelector('.theme-btn').innerText = '‚òÄÔ∏è';
        }

        // Load User
        const t = localStorage.getItem('bugler_token');
        const u = localStorage.getItem('bugler_user');
        if(t && u) {
            authToken=t; currentUser=u;
            updateStatus();
            document.getElementById('profileBtn').style.display='flex';
            document.getElementById('profileName').innerText=u;
            showSection('paceSelect');
        }
    };

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function setPace(m) { currentMode=m; showSection('langSelect'); }
    function setLanguage(l) { currentLang=l; renderLevels(); showSection('levelMenu'); }

    function renderLevels() {
        const grid = document.getElementById('dynamicLevelGrid');
        grid.innerHTML = "";
        const list = contentDB[currentMode][currentLang];
        document.getElementById('menuTitle').innerText = `${currentLang.toUpperCase()} Levels`;
        list.forEach((_, i) => {
            const btn = document.createElement('button');
            btn.className = 'level-btn';
            btn.innerText = i+1;
            btn.onclick = () => loadLevel(i);
            grid.appendChild(btn);
        });
    }

    function loadLevel(idx) {
        currentLevelIdx = idx;
        const data = contentDB[currentMode][currentLang][idx];
        document.getElementById('levelTitle').innerText = `Level ${idx+1}: ${data.title}`;
        document.getElementById('levelDesc').innerText = data.type==='quiz'? data.q : data.desc;
        
        const hintBox = document.querySelector('.hint-box');
        if(data.hint) { document.getElementById('levelHintText').innerText=data.hint; hintBox.style.display='block'; }
        else hintBox.style.display='none';

        const qa = document.getElementById('quizArea');
        const ea = document.getElementById('editorArea');
        
        if(data.type==='quiz') {
            qa.style.display='block'; ea.style.display='none';
            qa.innerHTML="";
            let opts = data.a.map((t,i)=>({t, isC:i===data.correct}));
            opts.sort(()=>Math.random()-0.5);
            opts.forEach(o=>{
                const b=document.createElement('button');
                b.className='quiz-option';
                b.innerText=o.t;
                b.onclick=()=>{ 
                    if(o.isC) { alert("Correct! üéâ"); saveProgress(); showSection('levelMenu'); }
                    else alert("Try again! ‚ùå");
                };
                qa.appendChild(b);
            });
        } else {
            qa.style.display='none'; ea.style.display='block';
            document.getElementById('codeEditor').value="// Write code here...";
            document.getElementById('consoleOutput').style.display='none';
            document.getElementById('htmlPreview').style.display='none';
        }
        showSection('gameScreen');
    }

    function runCode() {
        const code = document.getElementById('codeEditor').value;
        const out = document.getElementById('consoleOutput');
        const data = contentDB[currentMode][currentLang][currentLevelIdx];
        out.style.display='block'; out.className='console-output';
        
        if(currentLang==='javascript') {
            try {
                let logs=[];
                const old=console.log;
                console.log=(...a)=>logs.push(a.join(' '));
                eval(code);
                console.log=old;
                out.innerText = "> " + logs.join('\n> ');
                if(code.includes(data.solution)||logs.join('').includes(data.check)) success();
                else out.innerText+="\n[Sys] Logic missing: "+data.check;
            } catch(e) { out.className+=' error'; out.innerText=e.message; }
        } else if(currentLang==='html') {
            const pre=document.getElementById('htmlPreview');
            pre.style.display='block'; pre.innerHTML=code;
            out.innerText="Rendered HTML.";
            if(code.includes(data.check)) success();
        } else {
            out.innerText="Compiling...";
            setTimeout(()=>{
                if(code.includes(data.solution)||code.includes(data.check)) {
                    out.innerText="> Execution Success ‚úÖ"; success();
                } else {
                    out.className+=' error'; out.innerText="> Logic Incorrect ‚ùå\n> Use: "+data.solution;
                }
            },500);
        }
    }

    function success() { setTimeout(()=>{ alert("Level Complete! üéâ"); saveProgress(); showSection('levelMenu'); },500); }

    function toggleChat() { document.getElementById('chatWindow').classList.toggle('open'); }
    function toggleProfile() { document.getElementById('profileDropdown').classList.toggle('open'); }
    function logout() { localStorage.clear(); location.reload(); }

    function sendChat() {
        const inp = document.getElementById('chatInput');
        const txt = inp.value.trim();
        if(!txt) return;
        addMsg(txt, 'user');
        inp.value='';
        setTimeout(()=>{
            let r="";
            let low = txt.toLowerCase();
            if(low.includes('hello') || low.includes('hi')) r = "Hello! Ready to code? üöÄ";
            else if(low.includes('variable')) r = "A variable is like a container that stores data values. In Python: `x = 5`";
            else if(low.includes('loop')) r = "Loops repeat code! `for i in range(5):` runs 5 times.";
            else if(low.includes('print')) r = "Use `print('text')` in Python or `console.log('text')` in JS.";
            else if(low.includes('function')) r = "Functions are reusable blocks of code. `def my_func():`";
            else if(low.includes('array') || low.includes('list')) r = "Arrays (or lists) store multiple items: `[1, 2, 3]`";
            else if(low.includes('error') || low.includes('bug')) r = "Check your spelling and punctuation! Missing a `;` or `)`?";
            else if(low.includes('thank')) r = "You're welcome! Happy coding!";
            else r = "I'm still learning! For complex doubts, ask Gemini AI: <a href='https://gemini.google.com/app' target='_blank'>Ask Gemini</a>";
            addMsg(r, 'bot');
        },600);
    }

    function addMsg(t, s) {
        const d=document.createElement('div');
        d.className=`msg ${s}`; d.innerHTML=t;
        document.getElementById('chatMessages').appendChild(d);
    }

    // --- CREATIVE STATUS LOGIC ---
    function updateStatus() {
        let count = parseInt(localStorage.getItem('login_count') || '0');
        let rank = "Rookie üê£";
        if(count > 5) rank = "Regular üß¢";
        if(count > 20) rank = "Pro ü¶Ö";
        if(count > 50) rank = "Legend üëë";
        
        document.getElementById('userRank').innerText = rank;
        document.getElementById('loginCount').innerText = "Logins: " + count;
    }

    async function handleLogin() {
        const u = document.getElementById('loginUser').value;
        const p = document.getElementById('loginPass').value;
        const m = document.getElementById('loginMsg');
        m.innerText="Connecting...";
        try {
            const res = await fetch(`${API_URL}/login`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p})});
            const d = await res.json();
            if(res.ok) {
                authToken=d.token; currentUser=d.username;
                localStorage.setItem('bugler_token', d.token);
                localStorage.setItem('bugler_user', d.username);
                
                // Track Login Count for Rank
                let count = parseInt(localStorage.getItem('login_count') || '0');
                localStorage.setItem('login_count', count + 1);
                
                location.reload();
            } else { m.innerText=d.message; m.className="error"; }
        } catch(e) { m.innerText="Server Offline"; m.className="error"; }
    }

    async function handleRegister() {
        const u = document.getElementById('regUser').value;
        const p = document.getElementById('regPass').value;
        const m = document.getElementById('regMsg');
        try {
            const res = await fetch(`${API_URL}/register`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p})});
            if(res.ok) { m.innerText="Success! Login now."; m.className="success"; }
            else { m.innerText="Error (User exists?)"; m.className="error"; }
        } catch(e) { m.innerText="Server Offline"; m.className="error"; }
    }

    async function saveProgress() {
        if(!authToken) return;
        try { await fetch(`${API_URL}/progress`, {method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${authToken}`}, body:JSON.stringify({username:currentUser, progressData:{level:100}})}); } catch(e){}
    }
  </script>
</body>
</html>